{{/*
###
# Custom Functions
###
*/ -}}

# Time ZSH loadup, read more here: https://blog.mattclemente.com/2020/06/26/oh-my-zsh-slow-to-load.html#summary
timezsh() {
  shell=${1-$SHELL}
  for i in $(seq 1 10); do /usr/bin/time $shell -i -c exit; done
}

# Time p10k loadup, read more here: https://github.com/romkatv/powerlevel10k/blob/master/README.md#is-powerlevel10k-fast-to-load
timep10k() {
  time (repeat 10 zsh -dfis <<< 'source ~/.p10k.zsh; source ~/.oh-my-zsh/custom/themes/powerlevel10k/powerlevel10k.zsh-theme')
}

# Kill apps that match string
# Based on script found on here: https://github.com/sunknudsen/privacy-guides/tree/master/how-to-make-sure-app-is-not-running-in-the-background-on-macos
function killapps() {
  IFS=$'\n'
  red=$(tput setaf 1)
  normal=$(tput sgr0)
  if [ -z "$1" ] || [ "$1" = "--help" ]; then
    printf "%s\n" "Usage: kill-apps string"
    return 0
  fi
  printf "%s\n" "Finding apps that match “$1”…"
  sleep 1
  processes=($(pgrep -afil "$1"))
  if [ ${#processes[@]} -eq 0 ]; then
    printf "%s\n" "No apps found"
    return 0
  else
    printf "%s\n" "${processes[@]}"
    printf "$red%s$normal" "Kill found apps (y or n)? "
    read -r answer
    if [ "$answer" = "y" ]; then
      printf "%s\n" "Killing found apps…"
      sleep 1
      for process in "${processes[@]}"; do
        echo $process | awk '{print $1}' | xargs sudo kill 2>&1 | grep -v "No such process"
      done
      printf "%s\n" "Done"
      return 0
    fi
  fi
}

###
# AWS SSO helper functions
###

function _get_aws_profile() {
    local config="${AWS_CONFIG_FILE}"
    test ! -f ${config} && echo "File ${config} does not exist" && return 1
    which fzf 2>&1 >/dev/null
    if [[ $? -ne 0 ]]; then
        select _aws_profile in $(cat "${config}" | grep '\[profile' | sed 's/\[profile \(.*\)]/\1/'); do
            echo $_aws_profile;
            break;
        done
    else
        echo $(cat "${config}" | grep '\[profile' | sed 's/\[profile \(.*\)]/\1/' | fzf)
    fi
}

function _get_aws_region() {
    local _aws_profile="$1"
    readonly PROFILE_CONFIG="$(sed -n "/${_aws_profile}/,/^ *$/p" "${AWS_CONFIG_FILE}")"

    local region=""
    [[ -z "${region}" ]] && region=$(echo "${PROFILE_CONFIG}" |  (grep '\<region=.*\>' || true) | sed -E 's/^region *= *([^ ]*).*$/\1/')
    echo $region
}

function al() {
  unset aws_profile
  unset aws_default_region

  aws_profile="$(_get_aws_profile)"
  aws_default_region=$(_get_aws_region "default")

  aws sso login --profile $aws_profile
}
